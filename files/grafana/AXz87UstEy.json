{"meta":{"type":"db","canSave":false,"canEdit":false,"canAdmin":false,"canStar":true,"canDelete":false,"slug":"controle-geral","url":"/d/AXz87UstEy/controle-geral","expires":"0001-01-01T00:00:00Z","created":"2024-12-10T15:31:09Z","updated":"2024-12-10T16:01:17Z","updatedBy":"admin","createdBy":"admin","version":10,"hasAcl":false,"isFolder":false,"folderId":8,"folderUid":"be6ic9ilsmww0c","folderTitle":"Moneto","folderUrl":"/dashboards/f/be6ic9ilsmww0c/moneto","provisioned":false,"provisionedExternalId":"","annotationsPermissions":{"dashboard":{"canAdd":false,"canEdit":false,"canDelete":false},"organization":{"canAdd":false,"canEdit":false,"canDelete":false}}},"dashboard":{"annotations":{"list":[{"builtIn":1,"datasource":{"type":"grafana","uid":"-- Grafana --"},"enable":true,"hide":true,"iconColor":"rgba(0, 211, 255, 1)","name":"Annotations & Alerts","type":"dashboard"}]},"description":"OKR 1: Entender onde há um maior gasto\nObjective: Identificar e entender as principais categorias de despesas pessoais.\n----------------------------------------------------------------\nKey Results:\n\n1. Rastrear todas as despesas diárias por 3 meses.\n2. Categorizar todas as despesas em pelo menos 5 categorias principais.\n3. Analisar o histórico de despesas para identificar as 3 maiores categorias de gasto.\n4. Reduzir os gastos em pelo menos uma das três maiores categorias em 10% até o final do trimestre.\n5. Criar um relatório mensal detalhado das despesas.\n\n----------------------------------------------------------------\nKPIs:\n\n1. Percentual de despesas rastreadas mensalmente.\n2. Número de categorias de despesas identificadas.\n3. Percentual de redução nos gastos nas categorias principais.\n4. Frequência de análise e relatório de despesas (mensalmente).\n5. Valor total das despesas mensais em comparação com meses anteriores.\n","editable":true,"fiscalYearStartMonth":0,"graphTooltip":0,"id":9,"links":[{"asDropdown":true,"icon":"dashboard","includeVars":false,"keepTime":false,"tags":[],"targetBlank":true,"title":"Itens pendentes","tooltip":"","type":"link","url":"http://82.180.136.148:3339/goto/UrD8B5VHR?orgId=1"}],"panels":[{"datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"description":"Total de meses gerenciando os gastos","fieldConfig":{"defaults":{"color":{"fixedColor":"#8a2be2","mode":"fixed"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]}},"overrides":[]},"gridPos":{"h":4,"w":5,"x":0,"y":0},"id":1,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","percentChangeColorMode":"standard","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"showPercentChange":false,"textMode":"auto","wideLayout":true},"pluginVersion":"11.1.3","targets":[{"dataset":"u766359255_rod","datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"editorMode":"code","format":"table","rawQuery":true,"rawSql":"SELECT\r\n  COUNT(DISTINCT DATE_FORMAT(created_at, '%Y-%m')) AS number_of_months\r\nFROM\r\n  TB_TRANSACTIONS A\r\nWHERE A.owner = $Owner ","refId":"A","sql":{"columns":[{"parameters":[{"name":"description","type":"functionParameter"}],"type":"function"}],"groupBy":[{"property":{"type":"string"},"type":"groupBy"}],"limit":50},"table":"bk_tb_transactions"}],"title":"Total Meses","type":"stat"},{"datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"description":"Valor gasto por mê e comparativo com mês anterior","fieldConfig":{"defaults":{"color":{"fixedColor":"#8a2be2","mode":"shades"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]},"unit":"currencyBRL"},"overrides":[]},"gridPos":{"h":4,"w":4,"x":5,"y":0},"id":6,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","percentChangeColorMode":"inverted","reduceOptions":{"calcs":["lastNotNull"],"fields":"/^ammount$/","values":false},"showPercentChange":true,"textMode":"auto","wideLayout":true},"pluginVersion":"11.1.3","targets":[{"dataset":"u766359255_rod","datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"editorMode":"code","format":"table","rawQuery":true,"rawSql":"SELECT\r\n  sum(A.value) as ammount,\r\n  month(A.date) as month\r\nFROM\r\n  TB_TRANSACTIONS A\r\n  join TB_CATEGORIES B on A.category = B.id\r\nwhere\r\n  B.positive is false\r\n  and B.internal is false\r\n  and A.owner = $Owner\r\nGROUP BY\r\n  month(A.date)","refId":"A","sql":{"columns":[{"parameters":[],"type":"function"}],"groupBy":[{"property":{"type":"string"},"type":"groupBy"}],"limit":50}}],"title":"Gastos por mês","type":"stat"},{"datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"description":"Últimas 50 transações registradas","fieldConfig":{"defaults":{"color":{"mode":"continuous-GrYlRd"},"custom":{"align":"auto","cellOptions":{"type":"auto"},"filterable":true,"inspect":true},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]},"unit":"currencyBRL"},"overrides":[{"matcher":{"id":"byName","options":"data"},"properties":[{"id":"custom.width","value":97}]},{"matcher":{"id":"byName","options":"valor"},"properties":[{"id":"custom.cellOptions","value":{"type":"color-text","wrapText":false}},{"id":"thresholds","value":{"mode":"absolute","steps":[{"color":"red","value":null},{"color":"green","value":0.01}]}},{"id":"color"}]},{"matcher":{"id":"byName","options":"descricao"},"properties":[{"id":"custom.width"}]},{"matcher":{"id":"byName","options":"categoria"},"properties":[{"id":"custom.width","value":179}]}]},"gridPos":{"h":10,"w":15,"x":9,"y":0},"id":9,"options":{"cellHeight":"sm","footer":{"countRows":false,"enablePagination":false,"fields":"","reducer":["sum"],"show":false},"showHeader":true,"sortBy":[{"desc":true,"displayName":"data"}]},"pluginVersion":"11.1.3","targets":[{"dataset":"u766359255_rod","datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"editorMode":"code","format":"table","rawQuery":true,"rawSql":"SELECT\r\n  A.date as data,\r\n  A.description as descricao,\r\n  B.name as categoria,\r\n  CASE\r\n    WHEN B.positive THEN A.value\r\n    ELSE A.value * -1\r\n  END as valor,\r\n  C.name as conta\r\nFROM\r\n  TB_TRANSACTIONS A\r\n  JOIN TB_CATEGORIES B on A.category = B.id\r\n  join TB_ACCOUNTS C on A.account = C.id\r\nWHERE A.owner = $Owner \r\nORDER BY\r\n  A.date DESC\r\nLIMIT\r\n  50","refId":"A","sql":{"columns":[{"parameters":[],"type":"function"}],"groupBy":[{"property":{"type":"string"},"type":"groupBy"}],"limit":50},"table":"bk_tb_transactions"}],"title":"Últimas transações","transformations":[{"id":"convertFieldType","options":{"conversions":[{"dateFormat":"DD/MM/YYYY","destinationType":"string","targetField":"data","timezone":"America/Sao_Paulo"}],"fields":{}}}],"type":"table"},{"datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"description":"Top 5 categorias de gastos","fieldConfig":{"defaults":{"color":{"fixedColor":"#8a2be2","mode":"shades"},"custom":{"hideFrom":{"legend":false,"tooltip":false,"viz":false}},"mappings":[],"unit":"currencyBRL"},"overrides":[]},"gridPos":{"h":8,"w":5,"x":0,"y":4},"id":5,"options":{"displayLabels":["percent"],"legend":{"calcs":[],"displayMode":"list","placement":"right","showLegend":false,"values":[]},"pieType":"donut","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":true},"tooltip":{"mode":"single","sort":"none"}},"pluginVersion":"11.1.3","targets":[{"dataset":"u766359255_rod","datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"editorMode":"code","format":"table","rawQuery":true,"rawSql":"SELECT\r\n  SUM(A.value) AS TOTAL,\r\n  B.name\r\nFROM\r\n  TB_TRANSACTIONS A\r\n  JOIN TB_CATEGORIES B ON A.category = B.id\r\nWHERE\r\n  B.positive IS FALSE\r\n  AND B.internal IS FALSE\r\n  AND A.owner = $Owner\r\nGROUP BY\r\n  A.category\r\nORDER BY\r\n  TOTAL DESC\r\nLIMIT\r\n  5","refId":"A","sql":{"columns":[{"parameters":[],"type":"function"}],"groupBy":[{"property":{"type":"string"},"type":"groupBy"}],"limit":50}}],"title":"5º Gasto/Categorias","type":"piechart"},{"datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"fieldConfig":{"defaults":{"color":{"fixedColor":"#8a2be2","mode":"shades"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]}},"overrides":[]},"gridPos":{"h":4,"w":4,"x":5,"y":4},"id":2,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","percentChangeColorMode":"standard","reduceOptions":{"calcs":["lastNotNull"],"fields":"/^transactions$/","values":false},"showPercentChange":true,"textMode":"auto","wideLayout":true},"pluginVersion":"11.1.3","targets":[{"dataset":"u766359255_rod","datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"editorMode":"code","format":"table","rawQuery":true,"rawSql":"SELECT\r\n  count(A.id) as transactions,\r\n  month(A.date) as month\r\nFROM\r\n  TB_TRANSACTIONS A\r\n   WHERE A.owner = $Owner \r\nGROUP BY\r\n  month(A.date)","refId":"A","sql":{"columns":[{"parameters":[],"type":"function"}],"groupBy":[{"property":{"type":"string"},"type":"groupBy"}],"limit":50}}],"title":"Transações por mês","type":"stat"},{"datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"description":"Total de categorias registradas no mês","fieldConfig":{"defaults":{"color":{"fixedColor":"#8a2be2","mode":"shades"},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]},"unit":"short"},"overrides":[]},"gridPos":{"h":4,"w":4,"x":5,"y":8},"id":8,"options":{"colorMode":"value","graphMode":"area","justifyMode":"auto","orientation":"auto","percentChangeColorMode":"inverted","reduceOptions":{"calcs":["lastNotNull"],"fields":"/^categories$/","values":false},"showPercentChange":true,"textMode":"auto","wideLayout":true},"pluginVersion":"11.1.3","targets":[{"dataset":"u766359255_rod","datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"editorMode":"code","format":"table","rawQuery":true,"rawSql":"SELECT\r\n  count(A.category) as categories,\r\n  month(A.date) as month\r\nFROM\r\n  TB_TRANSACTIONS A\r\n  join TB_CATEGORIES B on A.category = B.id\r\nwhere\r\n  B.positive is false\r\n  and B.internal is false\r\n  and A.owner = $Owner\r\nGROUP BY\r\n  month(A.date)","refId":"A","sql":{"columns":[{"parameters":[],"type":"function"}],"groupBy":[{"property":{"type":"string"},"type":"groupBy"}],"limit":50}}],"title":"Categorias registradas","type":"stat"},{"datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"description":"Top 3 maiores gastos por mês","fieldConfig":{"defaults":{"color":{"fixedColor":"#8a2be2","mode":"shades"},"custom":{"axisBorderShow":false,"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","fillOpacity":80,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineWidth":1,"scaleDistribution":{"type":"linear"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null},{"color":"red","value":80}]},"unit":"currencyBRL"},"overrides":[]},"gridPos":{"h":7,"w":15,"x":9,"y":10},"id":4,"options":{"barRadius":0,"barWidth":0.97,"fullHighlight":false,"groupWidth":0.7,"legend":{"calcs":[],"displayMode":"list","placement":"right","showLegend":false},"orientation":"auto","showValue":"auto","stacking":"none","tooltip":{"mode":"single","sort":"none"},"xField":"month","xTickLabelRotation":0,"xTickLabelSpacing":0},"targets":[{"dataset":"u766359255_rod","datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"editorMode":"code","format":"table","rawQuery":true,"rawSql":"WITH\r\n  QuarterlyCategorySpend AS (\r\n    SELECT\r\n      A.category,\r\n      CONCAT(YEAR(A.date), '-', MONTH(A.date)) AS month,\r\n      SUM(A.value) AS total_spent,\r\n      ROW_NUMBER() OVER (\r\n        PARTITION BY\r\n          YEAR(A.date),\r\n          MONTH(A.date)\r\n        ORDER BY\r\n          SUM(A.value) DESC\r\n      ) AS ranking\r\n    FROM\r\n      TB_TRANSACTIONS A\r\n      join TB_CATEGORIES D on A.category = D.id\r\n    where\r\n      D.internal is false\r\n      and D.positive is false\r\n    \tand A.owner = $Owner\r\n    GROUP BY\r\n      A.category,\r\n      YEAR(A.date),\r\n      MONTH(A.date)\r\n  )\r\nSELECT\r\n  B.month,\r\n  MAX(\r\n    CASE\r\n      WHEN B.ranking = 1 THEN C.name\r\n    END\r\n  ) AS cat1,\r\n  MAX(\r\n    CASE\r\n      WHEN B.ranking = 1 THEN B.total_spent\r\n    END\r\n  ) AS cat_value1,\r\n  MAX(\r\n    CASE\r\n      WHEN B.ranking = 2 THEN C.name\r\n    END\r\n  ) AS cat2,\r\n  MAX(\r\n    CASE\r\n      WHEN B.ranking = 2 THEN B.total_spent\r\n    END\r\n  ) AS cat_value2,\r\n  MAX(\r\n    CASE\r\n      WHEN B.ranking = 3 THEN C.name\r\n    END\r\n  ) AS cat3,\r\n  MAX(\r\n    CASE\r\n      WHEN B.ranking = 3 THEN B.total_spent\r\n    END\r\n  ) AS cat_value3\r\nFROM\r\n  QuarterlyCategorySpend B\r\n  join TB_CATEGORIES C on B.category = C.id\r\nWHERE\r\n  B.ranking <= 3\r\nGROUP BY\r\n  B.month\r\nORDER BY\r\n  B.month\r\nLIMIT\r\n  5","refId":"A","sql":{"columns":[{"parameters":[],"type":"function"}],"groupBy":[{"property":{"type":"string"},"type":"groupBy"}],"limit":50}}],"title":"3º Gastos/Mês","type":"barchart"},{"datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"description":"","fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisBorderShow":false,"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","fillOpacity":80,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineWidth":1,"scaleDistribution":{"type":"linear"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]}},"overrides":[{"matcher":{"id":"byName","options":"entradas"},"properties":[{"id":"unit","value":"currencyBRL"},{"id":"color","value":{"fixedColor":"#8a2be2","mode":"fixed"}}]},{"matcher":{"id":"byName","options":"saidas"},"properties":[{"id":"unit","value":"currencyBRL"},{"id":"color","value":{"fixedColor":"light-purple","mode":"shades"}}]}]},"gridPos":{"h":5,"w":9,"x":0,"y":12},"id":11,"options":{"barRadius":0,"barWidth":0.97,"fullHighlight":true,"groupWidth":0.7,"legend":{"calcs":[],"displayMode":"list","placement":"right","showLegend":true},"orientation":"auto","showValue":"auto","stacking":"none","tooltip":{"mode":"single","sort":"none"},"xField":"mes","xTickLabelRotation":0,"xTickLabelSpacing":0},"pluginVersion":"11.1.3","targets":[{"dataset":"u766359255_rod","datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"editorMode":"code","format":"table","rawQuery":true,"rawSql":"select\r\n  monthname(a.date) mes,\r\n  sum(\r\n    case\r\n      when b.positive then a.value\r\n      else 0\r\n    end\r\n  ) entradas,\r\n  sum(\r\n    case\r\n      when b.positive is false then a.value\r\n      else 0\r\n    end\r\n  ) saidas\r\nfrom\r\n  TB_TRANSACTIONS a\r\n  join TB_CATEGORIES b on a.category = b.id\r\nwhere a.owner = $Owner \r\ngroup by\r\n  month(a.date)\r\nlimit\r\n  5","refId":"A","sql":{"columns":[{"parameters":[],"type":"function"}],"groupBy":[{"property":{"type":"string"},"type":"groupBy"}],"limit":50}}],"title":"Entradas \\ Saídas por mês","type":"barchart"},{"datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"description":"Apenas contas com saldo diferente de 0","fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"custom":{"align":"auto","cellOptions":{"type":"color-text","wrapText":false},"filterable":true,"inspect":true},"decimals":2,"fieldMinMax":false,"mappings":[],"min":0,"thresholds":{"mode":"absolute","steps":[{"color":"light-red","value":null},{"color":"green","value":0}]},"unit":"currencyBRL"},"overrides":[{"matcher":{"id":"byName","options":"name"},"properties":[{"id":"custom.cellOptions","value":{"type":"auto"}}]}]},"gridPos":{"h":9,"w":9,"x":0,"y":17},"id":10,"options":{"cellHeight":"sm","footer":{"countRows":false,"enablePagination":false,"fields":"","reducer":["sum"],"show":false},"showHeader":false},"pluginVersion":"11.1.3","targets":[{"datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"editorMode":"code","format":"table","rawQuery":true,"rawSql":"select a.name\r\n     , a.ammount\r\n  from TB_ACCOUNTS a\r\n  where a.ammount != 0\r\n    and a.owner = $Owner \r\n  order by a.name asc","refId":"A","sql":{"columns":[{"parameters":[],"type":"function"}],"groupBy":[{"property":{"type":"string"},"type":"groupBy"}],"limit":50}}],"title":"Saldo atual","type":"table"},{"datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"description":"Top 3 categorias por trimestre com comparativo de redução","fieldConfig":{"defaults":{"color":{"fixedColor":"#8a2be2","mode":"shades"},"custom":{"axisBorderShow":false,"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","fillOpacity":80,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineWidth":1,"scaleDistribution":{"type":"linear"},"thresholdsStyle":{"mode":"off"}},"fieldMinMax":false,"mappings":[],"thresholds":{"mode":"percentage","steps":[{"color":"green","value":null}]},"unit":"currencyBRL"},"overrides":[{"matcher":{"id":"byRegexp","options":"/Percentual de redução/"},"properties":[{"id":"unit","value":"percent"}]}]},"gridPos":{"h":9,"w":15,"x":9,"y":17},"id":7,"options":{"barRadius":0,"barWidth":0.97,"fullHighlight":false,"groupWidth":0.7,"legend":{"calcs":[],"displayMode":"list","placement":"right","showLegend":true},"orientation":"auto","showValue":"auto","stacking":"normal","tooltip":{"mode":"single","sort":"none"},"xField":"categoria","xTickLabelMaxLength":15,"xTickLabelRotation":45,"xTickLabelSpacing":0},"targets":[{"dataset":"u766359255_rod","datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"editorMode":"code","format":"table","rawQuery":true,"rawSql":"WITH\r\n  QuarterlyCategorySpend AS (\r\n    SELECT\r\n      A.category,\r\n      CONCAT('T', QUARTER(date), '-', YEAR(date)) AS quarter,\r\n      SUM(value) AS total_spent,\r\n      ROW_NUMBER() OVER (\r\n        PARTITION BY\r\n          YEAR(A.date),\r\n          QUARTER(A.date)\r\n        ORDER BY\r\n          SUM(value) DESC\r\n      ) AS ranking\r\n    FROM\r\n      TB_TRANSACTIONS A\r\n      join TB_CATEGORIES B on A.category = B.id\r\n    where\r\n      B.positive is false\r\n      and B.internal is false\r\n      and A.owner = $Owner\r\n    GROUP BY\r\n      A.category,\r\n      YEAR(A.date),\r\n      QUARTER(A.date)\r\n  ),\r\n  Top3Categories AS (\r\n    SELECT\r\n      quarter,\r\n      category,\r\n      total_spent,\r\n      ranking,\r\n      LAG(total_spent) OVER (\r\n        PARTITION BY\r\n          category\r\n        ORDER BY\r\n          quarter\r\n      ) AS prev_total_spent\r\n    FROM\r\n      QuarterlyCategorySpend\r\n    WHERE\r\n      ranking <= 3\r\n  )\r\nSELECT\r\n  A.quarter as trimestre,\r\n  A.category,\r\n  B.name as categoria,\r\n  A.total_spent as 'Valor gasto',\r\n  A.prev_total_spent as 'Valor gasto anterior',\r\n  CASE\r\n    WHEN A.prev_total_spent IS NOT NULL THEN (\r\n      (A.prev_total_spent - A.total_spent) / A.prev_total_spent\r\n    ) * 100\r\n    ELSE NULL\r\n  END AS 'Percentual de redução'\r\nFROM\r\n  Top3Categories A\r\n  join TB_CATEGORIES B on A.category = B.id\r\nORDER BY\r\n  A.quarter,\r\n  A.ranking;","refId":"A","sql":{"columns":[{"parameters":[],"type":"function"}],"groupBy":[{"property":{"type":"string"},"type":"groupBy"}],"limit":50}}],"title":"3° gastos com redução","type":"barchart"},{"datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"description":"Top3 categorias com maior gasto por trimestre","fieldConfig":{"defaults":{"color":{"fixedColor":"#8a2be2","mode":"shades"},"custom":{"axisBorderShow":false,"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","fillOpacity":80,"gradientMode":"hue","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineWidth":1,"scaleDistribution":{"type":"linear"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green","value":null}]},"unit":"currencyBRL"},"overrides":[]},"gridPos":{"h":6,"w":15,"x":9,"y":26},"id":3,"options":{"barRadius":0,"barWidth":0.97,"fullHighlight":true,"groupWidth":0.7,"legend":{"calcs":[],"displayMode":"list","placement":"right","showLegend":false},"orientation":"auto","showValue":"auto","stacking":"none","tooltip":{"mode":"single","sort":"none"},"xField":"quarter","xTickLabelRotation":0,"xTickLabelSpacing":0},"pluginVersion":"11.1.3","targets":[{"dataset":"u766359255_rod","datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"editorMode":"code","format":"table","rawQuery":true,"rawSql":"WITH\r\n  QuarterlyCategorySpend AS (\r\n    SELECT\r\n      A.category,\r\n      CONCAT('T', QUARTER(A.date), '-', YEAR(A.date)) AS quarter,\r\n      SUM(A.value) AS total_spent,\r\n      ROW_NUMBER() OVER (\r\n        PARTITION BY\r\n          YEAR(A.date),\r\n          QUARTER(A.date)\r\n        ORDER BY\r\n          SUM(A.value) DESC\r\n      ) AS ranking\r\n    FROM\r\n      TB_TRANSACTIONS A\r\n      join TB_CATEGORIES D on A.category = D.id\r\n    where\r\n      D.internal is false\r\n      and D.positive is false\r\n      and A.owner = $Owner\r\n    GROUP BY\r\n      A.category,\r\n      YEAR(A.date),\r\n      QUARTER(A.date)\r\n  )\r\nSELECT\r\n  B.quarter,\r\n  MAX(\r\n    CASE\r\n      WHEN B.ranking = 1 THEN C.name\r\n    END\r\n  ) AS cat1,\r\n  MAX(\r\n    CASE\r\n      WHEN B.ranking = 1 THEN B.total_spent\r\n    END\r\n  ) AS cat_value1,\r\n  MAX(\r\n    CASE\r\n      WHEN B.ranking = 2 THEN C.name\r\n    END\r\n  ) AS cat2,\r\n  MAX(\r\n    CASE\r\n      WHEN B.ranking = 2 THEN B.total_spent\r\n    END\r\n  ) AS cat_value2,\r\n  MAX(\r\n    CASE\r\n      WHEN B.ranking = 3 THEN C.name\r\n    END\r\n  ) AS cat3,\r\n  MAX(\r\n    CASE\r\n      WHEN B.ranking = 3 THEN B.total_spent\r\n    END\r\n  ) AS cat_value3\r\nFROM\r\n  QuarterlyCategorySpend B\r\n  join TB_CATEGORIES C on B.category = C.id\r\nWHERE\r\n  B.ranking <= 3\r\nGROUP BY\r\n  B.quarter\r\nORDER BY\r\n  B.quarter\r\nLIMIT\r\n  4","refId":"A","sql":{"columns":[{"parameters":[],"type":"function"}],"groupBy":[{"property":{"type":"string"},"type":"groupBy"}],"limit":50}}],"title":"3º gastos Trimestre","type":"barchart"}],"refresh":"","schemaVersion":39,"tags":[],"templating":{"list":[{"current":{"selected":false,"text":"8","value":"8"},"datasource":{"type":"mysql","uid":"ae6ic5d2fgtfka"},"definition":"select a.id as __value\n         , a.name as __text\n  from TB_USERS a","description":"Usuário para filtrar as informações","hide":0,"includeAll":false,"label":"Usuário","multi":false,"name":"Owner","options":[],"query":"select a.id as __value\n         , a.name as __text\n  from TB_USERS a","refresh":1,"regex":"","skipUrlSync":false,"sort":1,"type":"query"}]},"time":{"from":"now-6h","to":"now"},"timepicker":{},"timezone":"browser","title":"Controle geral","uid":"AXz87UstEy","version":10,"weekStart":""}}